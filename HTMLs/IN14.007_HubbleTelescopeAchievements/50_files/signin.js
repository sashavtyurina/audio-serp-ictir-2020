define(['localization/copy','session','web/modules/country_selection','jquery'],function(copy,session,country_selection,$){var signin=function(){var _config={},self={},replacedHtml='';self.init=function(){if(session.fld('pelm_require_sign_in')&&session.fld('pelm_require_sign_in')!="undefined"&&typeof JSON.parse(session.fld('pelm_require_sign_in')).instr!='undefined'&&JSON.parse(session.fld('pelm_require_sign_in')).instr!='')
{$(function(){$('#signin_message').html(JSON.parse(session.fld('pelm_require_sign_in')).instr).show();});}
else{$('#signin_message').show();}
self.check_user();if($('.site-options .signin')&&typeof $('.site-options .signin')!=='undefined'){self.setLabel();}else{setTimeout(function(){if($('.site-options .signin')&&typeof $('.site-options .signin')!=='undefined'&&$('.site-options .signin').find('span').html()==''){self.setLabel();}},1000);}
self.bindElements();require(['modals','defaults'],function(modals,defaults){modals.bind(defaults.overlays.signIn);});self.fm_session_auth();};self.check_user=function(){require(['web/modules/my_account_lr/user'],function(user){return user.is_logged_in();});};self.bindElements=function(){$('.site-options .signin').click(function(){if($(this).hasClass('signed-out')){var source=$('.signin-frame').attr('data-src'),fbase_url=$('.signin-frame').attr('data-baseurl');if(fbase_url){source=fbase_url.replace(/\/$/,'')+country_selection.addSavedCountryCodeUrl(source);}
$('#signin-box .signin-frame').attr('src',source);}
dataLayer.push({'event':"eventTracker",'eventCategory':window._config.ga_product,'eventAction':'clicks','eventLabel':"signInGreyBar"});});$("#top_user_avatar").on('click',function(e){dataLayer.push({'event':"eventTracker",'eventCategory':window._config.ga_product,'eventAction':'clicks','eventLabel':"signInGreyBar"});});};self.setLabel=function(){var welcome_label=window._config.viafoura_flag?copy.viafoura.lbl_greybar_hello:copy.signin.lbl_welcome;var sign_in_label=window._config.viafoura_flag?copy.viafoura.lbl_greybar_join_now:copy.signin.lbl_signin;var fmuserinfo=session.fld('fmugcuserinfo');if(fmuserinfo){$('.site-options .signin').removeClass('signed-in signed-out').addClass('signed-in').attr('title',copy.signin.hover_signout);$('.site-options .signin').find('span').removeClass('sign-in sign-out').addClass('sign-out').html(welcome_label);var url_welcome=copy.page_url.url_my_profile;url_welcome='/'+url_welcome.replace(/^\//,"");replacedHtml=$('.site-options .signin').html();$('.site-options .signin').replaceWith('<div class="welcome"><a id="top_user_avatar" href="'+url_welcome+'?intcmp=supernav_user_avatar"><i class="icon-user"></i>'+welcome_label+'</a></div>');$('.toolbar-item.signin span').html(welcome_label);$('#greybar-viafoura span').last().html(copy.viafoura.lbl_comments_unread);}else{$('.site-options .signin').removeClass('signed-in signed-out').addClass('signed-out').attr('title',copy.signin.hover_signin);$('.site-options .signin').find('span').removeClass('sign-in sign-out').addClass('sign-in').html(sign_in_label);$('#greybar-viafoura span').last().html(copy.viafoura.lbl_comments_notifications);}};self.refreshLabel=function(){var welcome_label=window._config.viafoura_flag?copy.viafoura.lbl_greybar_hello:copy.signin.lbl_welcome;var fmuserinfo=session.fld('fmugcuserinfo');if(fmuserinfo){$('.site-options .signin').removeClass('signed-in signed-out').addClass('signed-in').attr('title',copy.signin.hover_signout);$('.site-options .signin').find('span').removeClass('sign-in sign-out').addClass('sign-out').html(welcome_label);var url_welcome=copy.page_url.url_my_profile;url_welcome='/'+url_welcome.replace(/^\//,"");replacedHtml=$('.site-options .signin').html();$('.site-options .signin').replaceWith('<div class="welcome"><a id="top_user_avatar" href="'+url_welcome+'?intcmp=supernav_user_avatar"><i class="icon-user"></i>'+welcome_label+'</a></div>');$('.toolbar-item.signin span').html(welcome_label);$('#greybar-viafoura span').last().html(copy.viafoura.lbl_comments_unread);}else{$('.site-options .signin').removeClass('signed-in signed-out').addClass('signed-out').attr('title',copy.signin.hover_signin);$('.site-options .signin').find('span').removeClass('sign-in sign-out').addClass('sign-in').html(welcome_label);$('#greybar-viafoura span').last().html(copy.viafoura.lbl_comments_notifications);if(replacedHtml){var replacedHtmlTemp=$('.site-options .signin').html();$('.site-options .signin').replaceWith(replacedHtml);replacedHtml=replacedHtmlTemp;}}};self.fm_session_auth=function(){if(typeof window._config.fm_session_auth_enabled!='undefined'&&window._config.fm_session_auth_enabled==false){return false;}
var fminfo=session.fld('fmugcuserinfo'),user_id="",last_auth=session.fld('fm_last_auth'),sabre_id=session.fld('SABRE_ID'),cur_date="",last_auth_date="",diff_hours=0,remb_user=session.fld('remember_user'),fm_session_hours=(typeof window._config.fm_session_hours!='undefined')?parseInt(window._config.fm_session_hours):24,fm_cookie_days=(typeof window._config.fm_cookie_days!='undefined')?parseInt(window._config.fm_cookie_days):30,fm_cookie_days_persistent=(typeof window._config.fm_cookie_days_persistent!='undefined')?parseInt(window._config.fm_cookie_days_persistent):365;if(!fminfo||!sabre_id){return false;}
fminfo=fminfo.split('|');if(fminfo.length==3&&typeof fminfo[1]!="undefined"){user_id=parseInt(fminfo[1]);}
else if(fminfo.length==4&&typeof fminfo[2]!="undefined"){user_id=parseInt(fminfo[2]);}
if(!user_id){return false;}
if(last_auth){cur_date=new Date().getTime();last_auth=parseInt(last_auth);last_auth_date=new Date(last_auth).getTime();diff_hours=Math.floor(Math.abs(cur_date-last_auth_date)/(60*60*1000));}
if(!last_auth||diff_hours>=fm_session_hours){__.a('/api/filemob/get_session_token?u='+user_id,function(data){if(!data){return;}
var wdomain=null;var thost=window.location.host;var xarr=thost.split(".");if(thost.indexOf('.dqs')>-1){wdomain=xarr[2];}else{wdomain=xarr[1];}
var dmStr='.'+wdomain+'.com'
var c_exp=fm_cookie_days;if(remb_user=='true'){c_exp=fm_cookie_days_persistent;}
session.save_cookie_dm('SABRE_ID',data,c_exp,null,null,dmStr);session.save_cookie_dm('fm_last_auth',(new Date().getTime()),c_exp,null,null,dmStr);if(fminfo&&typeof fminfo[0]!="undefined"){fminfo[0]=data;var c_val=fminfo.join("|");session.save_cookie_dm('fmugcuserinfo',encodeURIComponent(c_val),c_exp,null,null,dmStr);}});}};return self;};return signin();});;